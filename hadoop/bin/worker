#! /usr/bin/env bash

function configure() {
    /bin/configure
}

function configure_env() {
    set | sed -n '/^X_HADOOP_/s,X_HADOOP_\(.*\)=\(.*\),export \1=\2,p' >> /home/hdfs/.bashrc
    set | sed -n '/^X_HADOOP_/s,X_HADOOP_\(.*\)=\(.*\),export \1=\2,p' >> /home/yarn/.bashrc
}

function start_ssh() {
    /usr/sbin/sshd
}

function change_password() {
    echo "hdfs:hdfs"|chpasswd
    echo "yarn:yarn"|chpasswd
}

function start_datanode() {
    su -l hdfs -c '/opt/hadoop/bin/hdfs --daemon start datanode'
}

function start_nodemanager() {
    su -l hdfs -c '/opt/hadoop/bin/yarn --daemon start nodemanager'
}

function shutdown() {
    su -l hdfs -c '/opt/hadoop/bin/yarn --daemon stop nodemanager'
    su -l hdfs -c '/opt/hadoop/bin/hdfs --daemon stop datanode'
}

trap shutdown EXIT

configure &&
    configure_env &&
    start_ssh &&
    change_password &&
    start_datanode &&
    start_nodemanager &&
    echo "Worker started on $(hostname -i)" &&
    tail -f /dev/null
